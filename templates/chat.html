{% extends "base.html" %}

{% block title %}{{ current_room.name }} - Chat{% endblock %}

{% block styles %}
<style>
    header, footer {
        display: none;
    }
    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #14191D;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3e%3cpath fill='%23002d62' fill-opacity='0.1' d='M0,160L48,176C96,192,192,224,288,218.7C384,213,480,171,576,133.3C672,96,768,64,864,80C960,96,1056,160,1152,176C1248,192,1344,160,1392,144L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3e%3c/path%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: bottom;
        font-family: 'Poppins', sans-serif;
        color: #FFFFFF;
    }
    .chat-page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .chat-top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: linear-gradient(90deg, #002D62, #FDB813);
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1001;
        box-sizing: border-box;
    }
    .chat-top-bar a, .chat-top-bar button {
        color: white;
        text-decoration: none;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
    }
    .chat-top-bar .chat-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chat-top-bar .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #002D62;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    .chat-top-bar .chat-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .chat-top-bar h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: bold;
    }

    #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 80px 1rem 80px; /* Padding for fixed bars */
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message-container {
        display: flex;
        width: 100%;
    }
    .message-container.sender {
        justify-content: flex-end;
    }
    .message-container.receiver {
        justify-content: flex-start;
    }
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 20px;
        color: #FFFFFF;
    }
    .message-container.sender .message-bubble {
        background-color: #808080;
    }
    .message-container.receiver .message-bubble {
        background-color: #000000;
    }
    .message-bubble .author {
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .message-bubble .content {
        white-space: pre-wrap;
    }
    .message-bubble .timestamp {
        font-size: 0.75rem;
        color: #E0E0E0;
        text-align: right;
        margin-top: 5px;
        display: block;
    }
    .react-btn {
        background: none;
        border: none;
        color: #B0B0B0;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
    }
    .reactions-popover {
        position: absolute;
        background-color: #2A343D;
        border-radius: 20px;
        padding: 5px;
        display: none;
        gap: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .reactions-popover span {
        cursor: pointer;
        font-size: 1.5rem;
        padding: 5px;
    }
    .reactions-container {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }
    .reaction {
        background-color: #2A343D;
        border-radius: 20px;
        padding: 2px 8px;
        font-size: 0.8rem;
    }
    .quoted-message {
        background-color: #1F262D;
        border-left: 3px solid #007BFF;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 5px;
    }
    .quoted-message .author {
        font-weight: bold;
        font-size: 0.8rem;
    }
    .quoted-message .content {
        font-size: 0.9rem;
        color: #B0B0B0;
    }

    .chat-bottom-bar {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        padding: 0.5rem 1rem;
        background-color: #14191D;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 1001;
        box-sizing: border-box;
    }
    .chat-bottom-bar button {
        background: none;
        border: none;
        color: #B0B0B0;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }
    #message-input {
        flex-grow: 1;
        background-color: #2A343D;
        border: 1px solid #808080;
        border-radius: 20px;
        padding: 0.75rem;
        color: white;
        margin: 0 0.5rem;
    }

    /* Poll Modal Styles */
    .poll-modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
    }
    .poll-modal-content {
        background-color: #1F262D;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .poll-modal-content h3 {
        margin-top: 0;
        color: #FFFFFF;
    }
    .poll-modal-content input {
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-radius: 10px;
        border: 1px solid #808080;
        background-color: #2A343D;
        color: white;
        box-sizing: border-box;
    }
    .poll-options-container .poll-option {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .poll-options-container input {
        margin-bottom: 0;
        flex-grow: 1;
    }
    .poll-modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .poll-modal-buttons button {
        padding: 0.5rem 1.5rem;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: bold;
    }
    #create-poll-submit-btn {
        background-color: #007BFF;
        color: white;
    }
    #cancel-poll-btn, .remove-option-btn {
        background-color: #808080;
        color: white;
    }
    .remove-option-btn {
        margin-left: 0.5rem;
        padding: 0.5rem;
        font-size: 1rem;
        line-height: 1;
    }

    /* Poll Display Styles */
    .poll-container {
        padding: 15px;
        border: 1px solid #808080;
        border-radius: 15px;
        background-color: #2A343D;
    }
    .poll-question {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }
    .poll-option-bar {
        background-color: #1F262D;
        border: 1px solid #808080;
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .poll-option-fill {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background-color: #007BFF;
        opacity: 0.3;
        z-index: 1;
        transition: width 0.3s ease-in-out;
    }
    .poll-option-text {
        position: relative;
        z-index: 2;
    }
    .poll-option-votes {
        position: relative;
        z-index: 2;
        float: right;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div id="poll-modal-backdrop" class="poll-modal-backdrop">
    <div class="poll-modal-content">
        <h3>Create a Poll</h3>
        <input type="text" id="poll-question" placeholder="Enter your poll question">
        <div id="poll-options-container" class="poll-options-container">
            <div class="poll-option">
                <input type="text" class="poll-option-input" placeholder="Option 1">
            </div>
            <div class="poll-option">
                <input type="text" class="poll-option-input" placeholder="Option 2">
            </div>
        </div>
        <button id="add-poll-option-btn" style="background: none; border: 1px dashed #808080; color: #B0B0B0; width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 10px;">+ Add Option</button>
        <div class="poll-modal-buttons">
            <button id="cancel-poll-btn">Cancel</button>
            <button id="create-poll-submit-btn">Create Poll</button>
        </div>
    </div>
</div>
<div class="chat-page-container">
    <div class="chat-top-bar">
        <a href="{{ url_for('main.chat_list') }}">&larr;</a>
        <div class="chat-info">
            <div class="chat-avatar">
                {% if current_room.cover_image %}
                    <img src="{{ url_for('static', filename=current_room.cover_image) }}" alt="{{ current_room.name }}">
                {% else %}
                    <span>{{ current_room.name[0] | upper }}</span>
                {% endif %}
            </div>
            <h2>{{ current_room.name }}</h2>
        </div>
        <a href="{{ url_for('main.chat_room_info', room_id=current_room.id) }}" id="info-btn">&#8505;</a>
    </div>

    <div id="messages">
        <!-- Messages will be dynamically inserted here -->
    </div>

    <div class="chat-bottom-bar">
        <div id="reply-banner" style="display: none; padding: 5px; background-color: #2A343D; border-radius: 10px; margin-bottom: 5px;">
            <div id="reply-banner-text"></div>
            <button id="cancel-reply-btn" style="background: none; border: none; color: white; float: right;">&times;</button>
        </div>
        <div class="chat-input-container" style="display: flex; align-items: center; width: 100%;">
            <div id="mentions-autocomplete" class="autocomplete-items" style="display: none; bottom: 100%; left: 0; position: absolute; background-color: #2A343D; border: 1px solid #808080; border-radius: 10px;"></div>
            <input type="file" id="file-input" style="display: none;" multiple>
            <button id="media-btn">üñºÔ∏è</button>
            <button id="doc-btn">üìÑ</button>
            <button id="poll-btn">üìä</button>
            <button id="emoji-btn">üòÄ</button>
            <textarea id="message-input" placeholder="Type your message..." rows="1" style="resize: none; overflow-y: hidden;"></textarea>
            <button id="mic-btn">üé§</button>
            <button id="send-btn" style="padding: 0.5rem 1rem; margin-left: 5px; background-color: #007BFF; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-paper-plane" style="color: white; font-size: 1.2rem;"></i>
            </button>
        </div>
    <emoji-picker style="display: none; position: absolute; bottom: 60px; right: 20px; z-index: 1002;"></emoji-picker>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const currentRoomId = {{ current_room.id }};
    const currentUserId = {{ current_user.id }};

    // --- DOM Elements ---
    const messageWindow = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const mediaBtn = document.getElementById('media-btn');
    const docBtn = document.getElementById('doc-btn');
    const fileInput = document.getElementById('file-input');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.querySelector('emoji-picker');
    const micBtn = document.getElementById('mic-btn');
    const sendBtn = document.getElementById('send-btn');
    const mentionsAutocomplete = document.getElementById('mentions-autocomplete');
    const replyBanner = document.getElementById('reply-banner');
    const replyBannerText = document.getElementById('reply-banner-text');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');
    const pollBtn = document.getElementById('poll-btn');
    const pollModalBackdrop = document.getElementById('poll-modal-backdrop');
    const cancelPollBtn = document.getElementById('cancel-poll-btn');
    const addPollOptionBtn = document.getElementById('add-poll-option-btn');
    const pollOptionsContainer = document.getElementById('poll-options-container');
    const createPollSubmitBtn = document.getElementById('create-poll-submit-btn');
    const pollQuestionInput = document.getElementById('poll-question');

    let usersInRoom = [];
    let repliedToMessage = null;

    // --- Poll UI Handlers ---
    pollBtn.addEventListener('click', () => {
        pollModalBackdrop.style.display = 'flex';
    });

    cancelPollBtn.addEventListener('click', () => {
        pollModalBackdrop.style.display = 'none';
    });

    addPollOptionBtn.addEventListener('click', () => {
        const optionCount = pollOptionsContainer.children.length;
        const newOption = document.createElement('div');
        newOption.classList.add('poll-option');
        newOption.innerHTML = `
            <input type="text" class="poll-option-input" placeholder="Option ${optionCount + 1}">
            <button class="remove-option-btn">&times;</button>
        `;
        pollOptionsContainer.appendChild(newOption);
        newOption.querySelector('.remove-option-btn').addEventListener('click', (e) => {
            e.target.parentElement.remove();
        });
    });

    pollOptionsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-option-btn')) {
            e.target.parentElement.remove();
        }
    });

    createPollSubmitBtn.addEventListener('click', () => {
        const question = pollQuestionInput.value.trim();
        const options = [...pollOptionsContainer.querySelectorAll('.poll-option-input')]
            .map(input => input.value.trim())
            .filter(option => option !== '');

        if (!question || options.length < 2) {
            alert('Please enter a question and at least two options for the poll.');
            return;
        }

        socket.emit('create_poll', {
            room_id: currentRoomId,
            question: question,
            options: options
        });

        // Reset and hide modal
        pollQuestionInput.value = '';
        pollOptionsContainer.innerHTML = `
            <div class="poll-option"><input type="text" class="poll-option-input" placeholder="Option 1"></div>
            <div class="poll-option"><input type="text" class="poll-option-input" placeholder="Option 2"></div>
        `;
        pollModalBackdrop.style.display = 'none';
    });

    // --- SocketIO Event Handlers ---
    socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('join', { room_id: currentRoomId });
        fetchHistory();
    });

    socket.on('message', (data) => {
        if (data.room_id == currentRoomId) {
            addMessage(data);
        }
    });

    socket.on('message_reacted', (data) => {
        if (data.room_id == currentRoomId) {
            const reactionsContainer = document.getElementById(`reactions-${data.message_id}`);
            reactionsContainer.innerHTML = '';
            const reactions = data.reactions.reduce((acc, r) => {
                acc[r.reaction] = (acc[r.reaction] || 0) + 1;
                return acc;
            }, {});
            for (const [reaction, count] of Object.entries(reactions)) {
                const reactionEl = document.createElement('span');
                reactionEl.classList.add('reaction');
                reactionEl.textContent = `${reaction} ${count}`;
                reactionsContainer.appendChild(reactionEl);
            }
        }
    });

    socket.on('message_edited', (data) => {
        if (data.room_id == currentRoomId) {
            const messageContent = document.querySelector(`#message-${data.message_id} .content`);
            messageContent.textContent = data.new_content;
            const editedSpan = document.createElement('span');
            editedSpan.textContent = ' (edited)';
            editedSpan.style.fontSize = '0.8rem';
            editedSpan.style.color = '#B0B0B0';
            messageContent.appendChild(editedSpan);
        }
    });

    socket.on('message_deleted', (data) => {
        if (data.room_id == currentRoomId) {
            const messageContainer = document.getElementById(`message-${data.message_id}`);
            if (messageContainer) {
                messageContainer.innerHTML = '<div class="message-bubble"><i>Message deleted</i></div>';
            }
        }
    });

    socket.on('new_poll', (data) => {
        if (data.room_id == currentRoomId) {
            addPoll(data);
        }
    });

    socket.on('poll_update', (data) => {
        if (data.room_id == currentRoomId) {
            updatePoll(data);
        }
    });

    // --- UI Event Listeners ---
    messageWindow.addEventListener('click', function(e) {
        if (e.target.classList.contains('poll-option-button')) {
            const optionId = e.target.dataset.optionId;
            socket.emit('poll_vote', { option_id: optionId });
        } else if (e.target.classList.contains('react-btn')) {
            const messageId = e.target.dataset.messageId;
            const popover = document.getElementById(`popover-${messageId}`);
            popover.style.display = popover.style.display === 'none' ? 'flex' : 'none';
        } else if (e.target.classList.contains('reply-btn')) {
            const messageId = e.target.dataset.messageId;
            const messageContent = e.target.closest('.message-bubble').querySelector('.content').textContent;
            repliedToMessage = { id: messageId, content: messageContent };
            replyBannerText.textContent = `Replying to: "${messageContent.substring(0, 50)}..."`;
            replyBanner.style.display = 'block';
        } else if (e.target.dataset.reaction) {
            const messageId = e.target.parentElement.id.split('-')[1];
            const reaction = e.target.dataset.reaction;
            socket.emit('react_to_message', { message_id: messageId, reaction: reaction });
            e.target.parentElement.style.display = 'none';
        } else if (e.target.classList.contains('edit-btn')) {
            const messageId = e.target.dataset.messageId;
            const messageContent = e.target.closest('.message-bubble').querySelector('.content');
            const newContent = prompt('Edit your message:', messageContent.textContent);
            if (newContent) {
                socket.emit('edit_message', { message_id: messageId, content: newContent });
            }
        } else if (e.target.classList.contains('delete-btn')) {
            const messageId = e.target.dataset.messageId;
            if (confirm('Are you sure you want to delete this message?')) {
                socket.emit('delete_message', { message_id: messageId });
            }
        }
    });

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';

        const text = this.value;
        const atIndex = text.lastIndexOf('@');
        if (atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            showMentions(query);
        } else {
            mentionsAutocomplete.style.display = 'none';
        }
    });

    mentionsAutocomplete.addEventListener('click', (e) => {
        if (e.target && e.target.tagName === 'DIV') {
            const mentionText = e.target.dataset.username;
            const atIndex = messageInput.value.lastIndexOf('@');
            messageInput.value = messageInput.value.substring(0, atIndex) + `@${mentionText} `;
            mentionsAutocomplete.style.display = 'none';
            messageInput.focus();
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
            this.style.height = 'auto';
        }
    });

    sendBtn.addEventListener('click', () => {
        sendMessage();
        messageInput.style.height = 'auto';
    });

    mediaBtn.addEventListener('click', () => {
        fileInput.accept = "image/*";
        fileInput.click();
    });

    docBtn.addEventListener('click', () => {
        fileInput.accept = ".pdf,.doc,.docx";
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            for(const file of this.files) {
                uploadFile(file);
            }
        }
    });

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.style.display = 'none';
        }
    });

    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
    });

    // --- Speech-to-Text ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';

        micBtn.addEventListener('click', () => {
            micBtn.style.color = 'red';
            recognition.start();
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            messageInput.value += transcript;
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            micBtn.style.color = '#B0B0B0';
        };

        recognition.onend = () => {
            micBtn.style.color = '#B0B0B0';
        };

    } else {
        micBtn.style.display = 'none'; // Hide if not supported
    }

    // --- Helper Functions ---
    cancelReplyBtn.addEventListener('click', () => {
        repliedToMessage = null;
        replyBanner.style.display = 'none';
    });

    function addPoll(data) {
        const messageContainer = document.createElement('div');
        messageContainer.id = `message-${data.message_id}`;
        messageContainer.classList.add('message-container');
        messageContainer.classList.add(data.user_id === currentUserId ? 'sender' : 'receiver');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        const profilePicUrl = `/static/profile_pics/${data.user_profile_pic || 'default.jpg'}`;
        const ts = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let optionsHtml = '';
        for (const option of data.options) {
            optionsHtml += `
                <div class="poll-option-bar poll-option-button" data-option-id="${option.id}">
                    <div class="poll-option-fill" style="width: 0%;"></div>
                    <span class="poll-option-text">${option.text}</span>
                    <span class="poll-option-votes">0 votes</span>
                </div>
            `;
        }

        bubble.innerHTML = `
            <div class="author">
                <img src="${profilePicUrl}" alt="${data.user_name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                ${data.user_name}
            </div>
            <div class="poll-container" id="poll-${data.poll_id}">
                <div class="poll-question">${data.question}</div>
                <div class="poll-options">
                    ${optionsHtml}
                </div>
            </div>
            <div class="timestamp">${ts}</div>
        `;

        messageContainer.appendChild(bubble);
        messageWindow.appendChild(messageContainer);
        messageWindow.scrollTop = messageWindow.scrollHeight;
    }

    function updatePoll(data) {
        const pollContainer = document.getElementById(`poll-${data.poll_id}`);
        if (!pollContainer) return;

        const totalVotes = data.options.reduce((sum, opt) => sum + opt.votes, 0);

        for (const option of data.options) {
            const optionBar = pollContainer.querySelector(`[data-option-id="${option.id}"]`);
            if (optionBar) {
                const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                optionBar.querySelector('.poll-option-fill').style.width = `${percentage}%`;
                optionBar.querySelector('.poll-option-votes').textContent = `${option.votes} votes`;
            }
        }
    }

    function sendMessage() {
        const content = messageInput.value.trim();
        if (content) {
            let messageData = { room_id: currentRoomId, content: content };
            if (repliedToMessage) {
                messageData.replied_to_id = repliedToMessage.id;
            }
            socket.emit('message', messageData);
            messageInput.value = '';
            repliedToMessage = null;
            replyBanner.style.display = 'none';
        }
    }

    function fetchHistory() {
        fetch(`/chat/room/${currentRoomId}/users`)
            .then(response => response.json())
            .then(data => {
                usersInRoom = data;
            });

        fetch(`/chat/room/${currentRoomId}/history`)
            .then(response => response.json())
            .then(history => {
                messageWindow.innerHTML = '';
                history.forEach(msg => addMessage(msg));
                messageWindow.scrollTop = messageWindow.scrollHeight;
            });
    }

    function addMessage(data) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        if (data.user_id === currentUserId) {
            messageContainer.classList.add('sender');
        } else {
            messageContainer.classList.add('receiver');
        }

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        const ts = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let fileHtml = '';
        if (data.file_path) {
            const filePath = `/static/${data.file_path}`;
            if (data.file_name.match(/\.(jpeg|jpg|gif|png)$/i)) {
                 fileHtml = `<img src="${filePath}" alt="Image" style="max-width: 100%; border-radius: 10px; margin-top: 5px;">`;
            } else {
                 fileHtml = `<a href="${filePath}" target="_blank" class="chat-file-link">${data.file_name}</a>`;
            }
        }

        const profilePicUrl = `/static/profile_pics/${data.user_profile_pic || 'default.jpg'}`;

        let repliedToHtml = '';
        if (data.replied_to) {
            repliedToHtml = `
                <div class="quoted-message">
                    <div class="author">${data.replied_to.user_name}</div>
                    <div class="content">${data.replied_to.content.substring(0, 100)}...</div>
                </div>
            `;
        }

        bubble.innerHTML = `
            ${repliedToHtml}
            <div class="author">
                <img src="${profilePicUrl}" alt="${data.user_name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                ${data.user_name}
            </div>
            <div class="content">${data.content || ''}</div>
            ${fileHtml}
            <div class="timestamp">${ts}</div>
            <button class="react-btn" data-message-id="${data.message_id}">React</button>
            <div class="reactions-popover" id="popover-${data.message_id}">
                <span data-reaction="üëç">üëç</span>
                <span data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</span>
                <span data-reaction="üòÇ">üòÇ</span>
            </div>
            <button class="reply-btn" data-message-id="${data.message_id}">Reply</button>
            <div class="message-actions"></div>
            <div class="reactions-container" id="reactions-${data.message_id}"></div>
        `;

        if (data.user_id === currentUserId) {
            const actions = bubble.querySelector('.message-actions');
            actions.innerHTML = `
                <button class="edit-btn" data-message-id="${data.message_id}">Edit</button>
                <button class="delete-btn" data-message-id="${data.message_id}">Delete</button>
            `;
        }

        messageContainer.appendChild(bubble);
        messageWindow.appendChild(messageContainer);
        messageWindow.scrollTop = messageWindow.scrollHeight;
    }

    function showMentions(query) {
        mentionsAutocomplete.innerHTML = '';
        if (query.length === 0) {
            mentionsAutocomplete.style.display = 'none';
            return;
        }

        const filteredUsers = usersInRoom.filter(user =>
            user.name.toLowerCase().includes(query.toLowerCase())
        );

        if (filteredUsers.length > 0) {
            filteredUsers.forEach(user => {
                const item = document.createElement('div');
                item.textContent = user.name;
                item.dataset.username = user.name;
                item.style.padding = '10px';
                item.style.cursor = 'pointer';
                mentionsAutocomplete.appendChild(item);
            });
            mentionsAutocomplete.style.display = 'block';
        } else {
            mentionsAutocomplete.style.display = 'none';
        }
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/chat/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Upload failed: ' + data.error);
            } else {
                socket.emit('message', {
                    room_id: currentRoomId,
                    content: '',
                    file_path: data.file_path,
                    file_name: data.file_name
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during file upload.');
        });
    }
});
</script>
{% endblock %}
