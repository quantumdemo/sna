{% extends "base.html" %}

{% block title %}{{ current_room.name }} - Chat{% endblock %}

{% block styles %}
<style>
    footer {
        display: none;
    }
    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #14191D;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3e%3cpath fill='%23002d62' fill-opacity='0.1' d='M0,160L48,176C96,192,192,224,288,218.7C384,213,480,171,576,133.3C672,96,768,64,864,80C960,96,1056,160,1152,176C1248,192,1344,160,1392,144L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3e%3c/path%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: bottom;
        font-family: 'Poppins', sans-serif;
        color: #FFFFFF;
    }
    .chat-page-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    .chat-top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: linear-gradient(90deg, #002D62, #FDB813);
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1001;
        box-sizing: border-box;
    }
    .chat-top-bar a, .chat-top-bar button {
        color: white;
        text-decoration: none;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
    }
    .chat-top-bar .chat-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .chat-top-bar .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #002D62;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    .chat-top-bar .chat-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    .chat-top-bar h2 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: bold;
    }

    #messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 80px 1rem 80px; /* Padding for fixed bars */
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .message-container {
        display: flex;
        width: 100%;
    }
    .message-container.sender {
        justify-content: flex-end;
    }
    .message-container.receiver {
        justify-content: flex-start;
    }
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 20px;
        color: #FFFFFF;
    }
    .message-container.sender .message-bubble {
        background-color: #808080;
    }
    .message-container.receiver .message-bubble {
        background-color: #000000;
    }
    .message-bubble .author {
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .message-bubble .content {
        white-space: pre-wrap;
    }
    .message-bubble .timestamp {
        font-size: 0.75rem;
        color: #E0E0E0;
        text-align: right;
        margin-top: 5px;
        display: block;
    }
    .react-btn {
        background: none;
        border: none;
        color: #B0B0B0;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
    }
    .reactions-popover {
        position: absolute;
        background-color: #2A343D;
        border-radius: 20px;
        padding: 5px;
        display: none;
        gap: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .reactions-popover span {
        cursor: pointer;
        font-size: 1.5rem;
        padding: 5px;
    }
    .reactions-container {
        display: flex;
        gap: 5px;
        margin-top: 5px;
    }
    .reaction {
        background-color: #2A343D;
        border-radius: 20px;
        padding: 2px 8px;
        font-size: 0.8rem;
    }

    .chat-bottom-bar {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: #1F262D;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 1001;
        box-sizing: border-box;
    }
    .chat-bottom-bar button {
        background: none;
        border: none;
        color: #B0B0B0;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }
    #message-input {
        flex-grow: 1;
        background-color: #2A343D;
        border: 1px solid #808080;
        border-radius: 20px;
        padding: 0.75rem;
        color: white;
        margin: 0 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-page-container">
    <div class="chat-top-bar">
        <a href="{{ url_for('main.chat_list') }}">&larr;</a>
        <div class="chat-info">
            <div class="chat-avatar">
                {% if current_room.cover_image %}
                    <img src="{{ url_for('static', filename=current_room.cover_image) }}" alt="{{ current_room.name }}">
                {% else %}
                    <span>{{ current_room.name[0] | upper }}</span>
                {% endif %}
            </div>
            <h2>{{ current_room.name }}</h2>
        </div>
        <a href="{{ url_for('main.chat_room_info', room_id=current_room.id) }}" id="info-btn">&#8505;</a>
    </div>

    <div id="messages">
        <!-- Messages will be dynamically inserted here -->
    </div>

    <div class="chat-bottom-bar" style="position: relative;">
        <div id="mentions-autocomplete" class="autocomplete-items" style="display: none; bottom: 100%; left: 0; position: absolute; background-color: #2A343D; border: 1px solid #808080; border-radius: 10px;"></div>
        <input type="file" id="file-input" style="display: none;" multiple>
        <button id="media-btn">üñºÔ∏è</button>
        <button id="doc-btn">üìÑ</button>
        <button id="emoji-btn">üòÄ</button>
        <textarea id="message-input" placeholder="Type your message..." rows="1" style="resize: none; overflow-y: hidden;"></textarea>
        <button id="mic-btn">üé§</button>
    </div>
    <emoji-picker style="display: none; position: absolute; bottom: 60px; right: 20px; z-index: 1002;"></emoji-picker>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const currentRoomId = {{ current_room.id }};
    const currentUserId = {{ current_user.id }};

    // --- DOM Elements ---
    const messageWindow = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const mediaBtn = document.getElementById('media-btn');
    const docBtn = document.getElementById('doc-btn');
    const fileInput = document.getElementById('file-input');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPicker = document.querySelector('emoji-picker');
    const micBtn = document.getElementById('mic-btn');
    const mentionsAutocomplete = document.getElementById('mentions-autocomplete');
    let usersInRoom = [];

    // --- SocketIO Event Handlers ---
    socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('join', { room_id: currentRoomId });
        fetchHistory();
    });

    socket.on('message', (data) => {
        if (data.room_id == currentRoomId) {
            addMessage(data);
        }
    });

    socket.on('message_reacted', (data) => {
        if (data.room_id == currentRoomId) {
            const reactionsContainer = document.getElementById(`reactions-${data.message_id}`);
            reactionsContainer.innerHTML = '';
            const reactions = data.reactions.reduce((acc, r) => {
                acc[r.reaction] = (acc[r.reaction] || 0) + 1;
                return acc;
            }, {});
            for (const [reaction, count] of Object.entries(reactions)) {
                const reactionEl = document.createElement('span');
                reactionEl.classList.add('reaction');
                reactionEl.textContent = `${reaction} ${count}`;
                reactionsContainer.appendChild(reactionEl);
            }
        }
    });

    // --- UI Event Listeners ---
    messageWindow.addEventListener('click', function(e) {
        if (e.target.classList.contains('react-btn')) {
            const messageId = e.target.dataset.messageId;
            const popover = document.getElementById(`popover-${messageId}`);
            popover.style.display = popover.style.display === 'none' ? 'flex' : 'none';
        }
        if (e.target.dataset.reaction) {
            const messageId = e.target.parentElement.id.split('-')[1];
            const reaction = e.target.dataset.reaction;
            socket.emit('react_to_message', { message_id: messageId, reaction: reaction });
            e.target.parentElement.style.display = 'none';
        }
    });

    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';

        const text = this.value;
        const atIndex = text.lastIndexOf('@');
        if (atIndex !== -1) {
            const query = text.substring(atIndex + 1);
            showMentions(query);
        } else {
            mentionsAutocomplete.style.display = 'none';
        }
    });

    mentionsAutocomplete.addEventListener('click', (e) => {
        if (e.target && e.target.tagName === 'DIV') {
            const mentionText = e.target.dataset.username;
            const atIndex = messageInput.value.lastIndexOf('@');
            messageInput.value = messageInput.value.substring(0, atIndex) + `@${mentionText} `;
            mentionsAutocomplete.style.display = 'none';
            messageInput.focus();
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
            this.style.height = 'auto';
        }
    });

    mediaBtn.addEventListener('click', () => {
        fileInput.accept = "image/*";
        fileInput.click();
    });

    docBtn.addEventListener('click', () => {
        fileInput.accept = ".pdf,.doc,.docx";
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            for(const file of this.files) {
                uploadFile(file);
            }
        }
    });

    emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.style.display = 'none';
        }
    });

    emojiPicker.addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
    });

    // --- Speech-to-Text ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';

        micBtn.addEventListener('click', () => {
            micBtn.style.color = 'red';
            recognition.start();
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            messageInput.value += transcript;
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            micBtn.style.color = '#B0B0B0';
        };

        recognition.onend = () => {
            micBtn.style.color = '#B0B0B0';
        };

    } else {
        micBtn.style.display = 'none'; // Hide if not supported
    }

    // --- Helper Functions ---
    function sendMessage() {
        const content = messageInput.value.trim();
        if (content) {
            socket.emit('message', { room_id: currentRoomId, content: content });
            messageInput.value = '';
        }
    }

    function fetchHistory() {
        fetch(`/chat/room/${currentRoomId}/users`)
            .then(response => response.json())
            .then(data => {
                usersInRoom = data;
            });

        fetch(`/chat/room/${currentRoomId}/history`)
            .then(response => response.json())
            .then(history => {
                messageWindow.innerHTML = '';
                history.forEach(msg => addMessage(msg));
                messageWindow.scrollTop = messageWindow.scrollHeight;
            });
    }

    function addMessage(data) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        if (data.user_id === currentUserId) {
            messageContainer.classList.add('sender');
        } else {
            messageContainer.classList.add('receiver');
        }

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        const ts = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let fileHtml = '';
        if (data.file_path) {
            const filePath = `/static/${data.file_path}`;
            if (data.file_name.match(/\.(jpeg|jpg|gif|png)$/i)) {
                 fileHtml = `<img src="${filePath}" alt="Image" style="max-width: 100%; border-radius: 10px; margin-top: 5px;">`;
            } else {
                 fileHtml = `<a href="${filePath}" target="_blank" class="chat-file-link">${data.file_name}</a>`;
            }
        }

        const profilePicUrl = `/static/profile_pics/${data.user_profile_pic || 'default.jpg'}`;

        bubble.innerHTML = `
            <div class="author">
                <img src="${profilePicUrl}" alt="${data.user_name}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                ${data.user_name}
            </div>
            <div class="content">${data.content || ''}</div>
            ${fileHtml}
            <div class="timestamp">${ts}</div>
            <button class="react-btn" data-message-id="${data.message_id}">React</button>
            <div class="reactions-popover" id="popover-${data.message_id}">
                <span data-reaction="üëç">üëç</span>
                <span data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</span>
                <span data-reaction="üòÇ">üòÇ</span>
            </div>
            <div class="reactions-container" id="reactions-${data.message_id}"></div>
        `;

        messageContainer.appendChild(bubble);
        messageWindow.appendChild(messageContainer);
        messageWindow.scrollTop = messageWindow.scrollHeight;
    }

    function showMentions(query) {
        mentionsAutocomplete.innerHTML = '';
        if (query.length === 0) {
            mentionsAutocomplete.style.display = 'none';
            return;
        }

        const filteredUsers = usersInRoom.filter(user =>
            user.name.toLowerCase().includes(query.toLowerCase())
        );

        if (filteredUsers.length > 0) {
            filteredUsers.forEach(user => {
                const item = document.createElement('div');
                item.textContent = user.name;
                item.dataset.username = user.name;
                item.style.padding = '10px';
                item.style.cursor = 'pointer';
                mentionsAutocomplete.appendChild(item);
            });
            mentionsAutocomplete.style.display = 'block';
        } else {
            mentionsAutocomplete.style.display = 'none';
        }
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/chat/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Upload failed: ' + data.error);
            } else {
                socket.emit('message', {
                    room_id: currentRoomId,
                    content: '',
                    file_path: data.file_path,
                    file_name: data.file_name
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during file upload.');
        });
    }
});
</script>
{% endblock %}
