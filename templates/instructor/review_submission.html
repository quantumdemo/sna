{% extends "base.html" %}

{% block title %}Review Submission for {{ submission.final_exam.title }}{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1>Review Submission</h1>
        <h2>Exam: {{ submission.final_exam.title }}</h2>
        <p>Student: {{ submission.student.name }}</p>
        <p>Submitted at: {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }} UTC</p>
    </div>

    <form action="{{ url_for('instructor.grade_submission', submission_id=submission.id) }}" method="post">
        <div class="submission-details">
            {% for answer in submission.answers.order_by('question_id') %}
            <div class="form-container-glassy question-review-card">
                <p><strong>Question {{ loop.index }}:</strong> {{ answer.question.question_text }}</p>
                <p><em>Type: {{ answer.question.question_type.replace('_', ' ')|title }} | Marks: {{ answer.question.marks }}</em></p>

                <hr>

                <div class="student-answer">
                    <p><strong>Student's Answer:</strong></p>
                    {% if answer.question.question_type.startswith('multiple_choice') %}
                        <ul>
                        {% for choice in answer.question.choices %}
                            <li>
                                <input type="{{ 'checkbox' if answer.question.question_type == 'multiple_choice_multiple' else 'radio' }}"
                                       {% if answer.selected_choice_id == choice.id or (answer.selected_choices and choice.id in answer.selected_choices) %}checked{% endif %} disabled>
                                <span {% if choice.is_correct %}class="correct-answer"{% endif %}>{{ choice.choice_text }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                    {% elif answer.question.question_type == 'true_false' %}
                        <p>{{ answer.true_false_answer }}</p>
                    {% elif answer.question.question_type in ['short_answer', 'essay'] %}
                        <p class="prose-glassy">{{ answer.text_answer }}</p>
                    {% elif answer.question.question_type == 'file_upload' %}
                        <a href="{{ url_for('static', filename=answer.file_path) }}" target="_blank">View Submitted File</a>
                    {% else %}
                        <p>No answer recorded.</p>
                    {% endif %}
                </div>

                {% if answer.question.question_type in ['short_answer', 'essay', 'file_upload'] %}
                <div class="grading-form">
                    <div class="form-group">
                        <label for="marks_{{ answer.id }}">Marks Awarded (out of {{ answer.question.marks }})</label>
                        <input type="number" step="0.5" name="marks_{{ answer.id }}" id="marks_{{ answer.id }}" value="{{ answer.marks_awarded or '' }}" class="input-glassy">
                    </div>
                    <div class="form-group">
                        <label for="feedback_{{ answer.id }}">Feedback</label>
                        <textarea name="feedback_{{ answer.id }}" id="feedback_{{ answer.id }}" rows="2" class="input-glassy">{{ answer.feedback or '' }}</textarea>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="form-actions" style="margin-top: 2rem;">
            <button type="submit" class="btn-primary-glass">Save Grades</button>
        </div>
    </form>
</div>
<style>
.question-review-card {
    margin-bottom: 2rem;
    padding: 1.5rem;
}
.correct-answer {
    font-weight: bold;
    color: #22c55e;
}
.student-answer {
    margin: 1rem 0;
}
.grading-form {
    margin-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-top: 1rem;
}
</style>
{% endblock %}
